---
- name: Bastion as default gateway
  hosts: control
  become: true

  vars:
    private_iface: enp7s0
    public_iface: eth0
    git_ssh_key_path: /root/.ssh/git_ed25519

  tasks:
    - name: Ensure required packages are installed
      apt:
        name:
          - iptables
          - iptables-persistent
        state: present
        update_cache: yes

    # -----------------------------
    # IPv4 forwarding
    # -----------------------------
    - name: Enable IPv4 forwarding at runtime and persistently
      ansible.posix.sysctl:
        name: net.ipv4.ip_forward
        value: "1"
        state: present
        reload: yes

    # -----------------------------
    # IPTABLES NAT + forwarding
    # -----------------------------
    - name: Enable NAT (MASQUERADE) on public interface
      ansible.posix.iptables:
        table: nat
        chain: POSTROUTING
        out_interface: "{{ public_iface }}"
        jump: MASQUERADE
        state: present

    - name: Allow forwarding from private to public
      ansible.posix.iptables:
        chain: FORWARD
        in_interface: "{{ private_iface }}"
        out_interface: "{{ public_iface }}"
        jump: ACCEPT
        state: present

    - name: Allow established connections from public to private
      ansible.posix.iptables:
        chain: FORWARD
        in_interface: "{{ public_iface }}"
        out_interface: "{{ private_iface }}"
        ctstate: ESTABLISHED,RELATED
        jump: ACCEPT
        state: present

    - name: Save iptables rules (iptables-persistent)
      command: netfilter-persistent save
      changed_when: false

 
